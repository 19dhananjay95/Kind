// App states (local = clicks, global = visitors)
App.CardPlayer.State: App.State
  App.State.new(Nat, Nat)

// Initial state
App.CardPlayer.init: App.Init<App.CardPlayer.State>
  App.Store.new<App.CardPlayer.State>(0, 0)

// Render function
App.CardPlayer.draw: App.Draw<App.CardPlayer.State>
  (state)
    <div style={"margin": "0", "height": "100%", "width": "100%", "background-image": "url(https://i.imgur.com/H5BB1V3.png)", "image-rendering": "pixelated"}>
      <div style={"height": "100%", "width": "100%", "display": "flex", "flex-direction": "column", "justify-content": "center"}>
        <header style={"background-image": "url(https://i.imgur.com/duRFrIR.png)", "width": "100%", "height": "64px", "image-rendering": "pixelated", "display": "flex", "justify-content": "space-between", "padding": "0 5px"}>
          <div style={"display": "flex"}>
          
          </div>
          <div style={"display": "flex", "justify-content": "flex-end"}>
            <img src=App.CardPlayer.header.button.invite style={"height": "100%", "image-rendering": "pixelated"}></img>
            <img src=App.CardPlayer.header.button.help   style={"height": "100%", "image-rendering": "pixelated"}></img>
            <img src=App.CardPlayer.header.button.list   style={"height": "100%", "image-rendering": "pixelated"}></img>
            <img src=App.CardPlayer.header.button.logout style={"height": "100%", "image-rendering": "pixelated"}></img>
          </div>
        </header>
        <div style={"display": "flex", "width": "100%", "justify-content": "center", "align-items": "center", "flex": "1"}>
          <div style={"display": "flex", "padding": "4px"}>
            { App.CardPlayer.card.user(App.KL.Game.Hero.Flina.hero, "https://i.imgur.com/T49eUdC.png") }
            { App.CardPlayer.card.others(App.KL.Game.Hero.Croni.hero, "https://i.imgur.com/1FZbfvI.png") }
            // { App.CardPlayer.card.others("ZOIO", "SENTINEL", "https://i.imgur.com/T49eUdC.png") }
            <div style={
              "max-height": "416px"
              "height": "416px" 
              "overflow": "auto"
              "display": "grid"
              "grid-template-columns": "repeat(5, minmax(0, 1fr))"
              "gap": "10px"
              "margin": "0 10px"
              "padding-top": "4px" // because of negative margin
            }>
              for card in [App.CardPlayer.portrait.hero(hero) for hero in App.KL.Game.Hero.list]:
                card
              for card in [App.CardPlayer.portrait.hero(hero) for hero in App.KL.Game.Hero.list]:
                card     
            </div>
          </div>
        </div>
        <footer style={"display": "flex", "padding": "5px"}>
          <div style={"flex": "1"}></div>
          <div><img style={"image-rendering": "pixelated"} src=App.CardPlayer.footer.ready_button></img></div>
          <div style={"flex": "1"}></div>
        </footer>
      </div>
    </div>

App.CardPlayer.header.button.invite: String  
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADkAAABACAYAAACgNd+MAAABYklEQVR42u3aPQrCQBAF4FzAI4iIYBqtbGJlaWGXxs7Gyk4vIFhY23gYj+M9LCIDmTAsu5ss5GdH38LDJIrwMcns4pqMZ3lByTanYro6qkoSMgAFFFBv5usLKgoooIACmmhFBkGBBBJIIFUgu1ifAtknMhYcKglki8js9S7koHMVSAlzHduAEjqa7PQ0HvPVBDKIw9fp+PG5V4n2diXYYvu03rI8JFBCo0MSQlaMQ8D0cKugHFcVzaiupK+KEubKIEiqlnmNcPJZ5HPZbFQhQ7qrrYuqRPrmSXPaUP9MNlkA2KoZZXcNjZwPzWrSdfVIRrieTYmUiR4p50bfMq7uM4MjeYoIWYybDagrYK/d9WeRtpWOC+IbKpB1iCbvR49sYwAJZI+Nx7dOrYua7voXyCF/nsSGD5BAAgkk9idRSSCB/I8/EAIIIIBBsW0PooIAlsA8PfeS/fLayvdEC2wrAJbjC8t/0cpcsmwIAAAAAElFTkSuQmCC"

App.CardPlayer.header.button.help: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADkAAABACAYAAACgNd+MAAABD0lEQVR42u3asQ3CMBCF4SzACAghJKioaELFAHRpGICKDhZgLsZhk0CQLKILsRK44Pj8W7rG3ZcXX+TY2XRRlFXlu1M53xyjqqzPAAoUKFCgQN+13F5I1DS0nnBvaIxp9oKCBAkSJEiQIEGCBJk6Mr/dSzmqOTPIT0BNqNtyBUP6gNqJBkNKzGS2f5XEm0DWga7MISXQFLKOkvPmkL6GFH3j6dqMTCFlV21LOmrkUCmOFqkJDIqU5xgmkV0/KVEi206itJFfnYf8q7tqb7NG23jMIpNIMok1aaq78rfOCtJ3YyO5JDUfBkmyJkGCBAlySKT5m5IAAQIECFALWKzOURXAX4GH9bUx516f0QCf4wFemMVkf3n/hwAAAABJRU5ErkJggg=="

App.CardPlayer.header.button.list: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADkAAABACAYAAACgNd+MAAAA7klEQVR42u3aQQqCQBTGcS/QESIiqFWrNrbqAO3cdIBW7uwCnavjdJOpWQiTDORDnfqc/4MHMiD4442fIhbLTeV8l6farQ9XqS4sBdTY2+ONiQIFChQo0KHQXzxOBkMVp2mCqr4oJEdmMUmQc0B+ux+nvF+TIGOAlCHEdgUJEmS+SPlHyOwnWT6eri1/HFvvW+H5f4XsVrjuL9rS4fkg2a4TIBer80e3Sdpd79syyNi6NJJ0JV1JV4IHJNuV4CFdSVfSVQXJh6zckWN+vWOSIEGCBAkSJEj+lAQIECBAgKMBq10j1QCtwMv+rgd81wu9A5PjjdGiEwAAAABJRU5ErkJggg=="

App.CardPlayer.header.button.logout: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADkAAABACAYAAACgNd+MAAABdUlEQVR42u3bOwrCQBAG4LmARxARwTR2NlpZWth5ABsrOz2Cd/AwHsebREZYCMGYmWyy7vyZgSGCMeRzNrt5bGi6OJacm92lnK/PkEkcMdDl9hb1fTJkLNREJdGhVA9EKH0LNCg1BRKUfgUKlNoCAUqSsA4laQyBTHWi4Mihkd5cBVmc7qLteSVzRWpbQHJkdQebPkNUMoDqSxNIzc7yuqv9I8kw0nslJXcKApB7R162Vdpsx2O6km1jGWeoHuwZT6oeNZtxcvN8lZrg9ZMjYyoRgBroX5AxWQXycjI7iNIsUgqEQEqbubbZdkbG9ox1pOZY1kKzqKTmd/yHaKEmkVpolsgqQJqjQP46rrNESoaSOhAOqQEmQTYNNV07Hi3QZO+qBZoeQjQnEOaQpq9CIJGjuJ4MQ0H2dwb6gGrT5LOQ7JE5TCnzh7COdKQjHelIRzrSJxD6VNBRTOqFn54NP9Ee/pUJ+JdfqsBjcYVKeOAHiQ7kfAPswOCUA++R1QAAAABJRU5ErkJggg=="

App.CardPlayer.portrait.hero(hero: App.KL.Game.Hero): DOM
  let fator = 2
  let bt = 2

  let portrait = hero@picture(true, 0)
  let inner =
    <div style={"width": "100%", "padding": "0 " | Nat.show(bt * fator) | "px", "display": "flex", "flex-direction": "column", "align-items": "center"}>
      <img style={"width": "100%", "image-rendering": "pixelated", "transform": "translateY(-"|Nat.show((2 + bt)*fator)|"px)", "margin-bottom": "4px"} src=portrait></img>
      <p style={"text-transform": "uppercase", "color": "white"}>hero@name</p>
    </div>

  App.CardPlayer.card.wrapper(44, 74, bt, fator, App.CardPlayer.portrait.hero.background, inner)

App.CardPlayer.portrait.hero.background: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAABKCAYAAADAKbZGAAAAcUlEQVR42u3bwQkAIQwEQNu4GuTasSPrVvwdeE+FBGZhyXcK2JSSNfVp4609ZJftF7tuxG7oyNgvGhgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgY+Dg43QY+3ZeBXMwEjZrO46oJAlgAAAAASUVORK5CYII="

App.CardPlayer.footer.ready_button: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAAAqCAYAAABr9d/aAAAC70lEQVR42u2aMWsVQRDH0/kBbNKksElhSBU0giJIAgkBFYsINgmKjdilUWzsEhQUIailYqG1FsHGxlQ2+gkEG3sLwULkZA7mmN03uzf79m7fu+S/8Oe9nZ27t29+N7N7793MDBoaWndt+eW3ClEAdbRBMgPII5psAIvKiDZGe/q7qsochDY5oJymSNfhlEiHGXdCmUfjsQ8C+PKgmVVjj0Eg51RIgJoek9QkcWwMCevf9JVPLfscVtxhWUoqwp+3EbHGVrIJspIGOSA/RCujltLK6+dxhK59dz9JJJQQOPb3bQ1YzQgNRzXAs6uPoQHKAchEz338UUuWABaP4crvRymxVwEC3nAgOgAXF3abtKT3pLn5nVrcX156BRVUiIPk1AA8eWo7Cg8QJwMvBpGYqQBD8ABxMvA0iFkAu4a4sfW+uvX8S1A0nuJ35c5Blt/1B5+qiytvax96pb60+7YS8DoH2KXaNkY0fn7thclv/fa7Vr/t/c+tfuSzcuN1de3eB8dOfd9WKk5TDTDWaJzmZvWj75Pj9+fvvwYiif1CNgAUYOSVHQOoZc2jw+8jYGLns/gBYCJADVbMFvp1wnJsG1QABECUUN6ctJXQzYcHKkBrCbUAlOeTfQCMbE5kpsX8KNAaQOsmJmSjHSfvVv3GFxcAdpCBIYB+xqQCPHPhmQqR50VjAOitTwTDsgbyesT3bKE10C+DKQB5jnzfKMfIVipGJoAnZi/VA0dxE5MLUJtnSXgSIM2TWDkASWQklc7CcQDKv12kcmCRvv78NZUAJQ/m5DxbM0mI4wDM3ZxYNzvTALAVnv/AjQaxT/mBWbr8pNUWCvjq3TcjsCw2bXdJ62psniViY4YXg7g+t9OrKFBcwui9xaaJxjfm748ca7H52ry6b5pnCZnhhSDSSW6e3nNUavLHTVqck+ClQIT61djwYuUUKqcseCGIfK/IT0nh2cxuJOMpY50Fz4dIN44sQOwHnoxxJ/B8iFDhx+YN7T9DLCkhPaM0KwAAAABJRU5ErkJggg=="

App.CardPlayer.card.user(hero: App.KL.Game.Hero, img: String): DOM
  let fator  = 2
  let bt     = 2
  let name   = hero@name
  let skills = Map.to_list!(hero@skills)
  let type   = "HEALER"
  let slot   = ((el) 
    <div style={
      "background-image": "url("|App.CardPlayer.card.button|")"
      "background-size": "100% 100%"
      "height": "20%"
      "width": "100%"
      // "font-size": "1.5rem"
      "border-radius": "5px"
      "display": "flex"
      "align-items": "center"
      "justify-content": "center"
      "color": "white"
    }>
      { el }
    </div>
  ) :: DOM -> DOM

  let inner  = 
    <div style={"display": "contents"}>
      <div style={"height": "40%", "width": "17%", "max-height": "40%", "overflow": "auto", "border-radius": "5px 0px 0px 5px"}>
        { slot(<span>"I"</span>) } // TODO LIST ICON
        for info in skills:
          let {key, skill} = info
            slot(<span>key</span>)
      </div>
      <div style={"width": "82%", "border-radius": "0 5px 5px 0", "padding": Nat.show(fator * bt) | "px"}>
        {App.CardPlayer.card.hero(App.KL.Game.Hero.Flina.hero, img)}
      </div>
    </div>
  
  <div style={"margin": "0 10px"}>
    { App.CardPlayer.card.wrapper(99, 208, bt, fator, "https://i.imgur.com/HTnAVKj.png", inner) }
  </div>

App.CardPlayer.card.others(hero: App.KL.Game.Hero img: String): DOM
  let fator = 2
  let bt    = 2
  let name  = hero@name
  let type = "HEALER"
  let inner = 
    <div style={"width": "100%", "border-radius": "0 5px 5px 0", "padding": Nat.show(fator * bt) | "px"}>
      {App.CardPlayer.card.hero(hero, img)}
    </div>
  
  <div style={"margin": "0 10px"}>
    { App.CardPlayer.card.wrapper(82, 208, bt, fator, "https://i.imgur.com/CI2xJrU.png", inner) }
  </div>

// // https://i.imgur.com/HTnAVKj.png
App.CardPlayer.card.wrapper(width: Nat, height: Nat, bt: Nat, fator: Nat, background: String, inner: DOM): DOM
  <div style={
    "height": Nat.show(fator * height) | "px", 
    "width": Nat.show(fator * width) | "px", 
    "display": "flex", 
    "background-image": "url("|background|")", 
    "background-size": "100% 100%", 
    "padding-top": Nat.show(fator * bt) | "px"
    // "margin": "0 10px"
    "image-rendering": "pixelated"
  }>
    {inner}
  </div>

App.CardPlayer.card.hero(hero: App.KL.Game.Hero, img: String): DOM
  let name  = hero@name
  let attrs = hero@attributes
  let type = "HEALER"
  <div style={"height": "100%"}>
    <div style={
      "height": "52%"
    }>
      {App.CardPlayer.card.img(name, type, img)}
    </div>
    {
      case attrs {
        none: <span style={"display": "none"}></span>
        some:
          <div style={"height": "48%", "width": "100%"}>
            {App.CardPlayer.card.attrs(attrs.value)}
          </div>
      }
    }
  </div>

// https://i.imgur.com/T49eUdC.png
App.CardPlayer.card.img(name: String, type: String, img: String): DOM
  <div style={"position": "relative", "height": "100%"}> 
    <div style={
      "position": "absolute", 
      "margin-left": "auto"
      "margin-right": "auto"
      "left": "0"
      "right": "0"
      "text-align": "center"
      "top": "-7%"
      "width": "55%",
      "height": "55%",
      "background-image": "url("|img|")",
      "background-size": "contain",
      "background-position": "center",
      "background-repeat": "no-repeat"
    }>
      // <img src=img style={"object-size": "contain"}></img>
    </div>
    <div style={
      "position": "absolute"
      "top": "70%"
      "left": "0"
      "right": "0"
      "margin": "auto"
      "height": "25%"
      "display": "flex"
      "flex-direction": "column"
      "justify-content": "space-around"
      "align-items": "center"
    }>
      <span style={"color": "white", "text-transform": "uppercase"}>name</span>
      <img src=App.CardPlayer.card.name_divisor style={"width": "50%"}></img>
      <span style={"color": "#871df0", "font-size": "small", "text-transform": "uppercase"}>type</span>
    </div>
  </div>

App.CardPlayer.card.attrs(attrs: App.KL.Game.Hero.Attributes): DOM
  let order     = ["damage", "resistance", "mobility", "range", "utility"]
  let attrs_map = App.KL.Game.Hero.Attributes.to_map(attrs) 
  <div style={"display": "contents"}> 
    for attr in order:
      let img = App.CardPlayer.card.attr_icons{attr}
      without img: <span style={"display": "none"}></span> // TODO
      <div style={"display": "contents"}>
        <div style={
          "height": "15%",
          "display": "flex", 
          "align-items": "center", 
          "padding": "4% 10%",
          "margin-top": if attr =? "damage" then "4%" else ""
        }>
          <div style={
            "flex": "1"
            "margin-right": "10%"
            "height": "100%"
          }>
            <img style={"width": "100%", "height": "100%", "object-fit": "contain", "image-rendering": "pixelated"} src=img></img>
          </div>
          <div style={"display": "flex", "height": "100%", "flex": "4", "align-items": "center"}>
            for j in [1 to 6]:
              let attr_value = attrs_map{attr}
              without attr_value: <span style={"display": "none"}></span>
              let bar = App.CardPlayer.card.attr_bar(attr_value, j)
              <div style={"margin": "0 3px", "display": "flex", "align-items": "center", "flex": "1"}><img style={"width": "100%", "image-rendering": "pixelated"} src=bar></img> </div>
          </div>
        </div>
        {
          if attr =? "utility" then <span></span>
          else 
            <div style={"display": "flex", "justify-content": "center"}>
              <img style={"width": "80%", "margin": "auto", "image-rendering": "pixelated"} src=App.CardPlayer.card.divisor></img>
            </div>
        }
      </div>
  </div>

App.CardPlayer.card.button: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAPCAYAAADtc08vAAAAsUlEQVR42mNgAAIzl67/5tPP/7fY8QCM+778x4ph8iC1ID0MpGjGaYiudhuKAIhvbjwfKwbJIVsorBj/nwFEwDTLqhXh1AzDIDUwQ+AGwDSDMMgWfBimDqQHxQCYJDEGwLwySA0gZAhOA9glHOEYZhA6RlaDYQCyAg/ZIqwY2QKsXjCRSARjXAbA5DG8ABOAGZKo1Y4VI2sG0XADkA2BSWLDyPIwfeAMBeMgBxI+jKwZAA9Tzqish/WQAAAAAElFTkSuQmCC"

App.CardPlayer.card.divisor: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAACCAYAAADsDAqEAAAAGUlEQVR42mNgl3D8P4od/zM4qOX/H8X5/wFLCtMnRwvN3AAAAABJRU5ErkJggg=="

App.CardPlayer.card.name_divisor: String
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC4AAAABCAYAAAChQ5zUAAAAKklEQVR42mPQlgz7z82j9R9Eg7CZSxcGjYzbZT/AaWpgZDORMTa3ILsVAD4KYiEWiGpBAAAAAElFTkSuQmCC"

App.CardPlayer.card.attr_bar(i: Nat, j: Nat): String
  case Nat.cmp(j, i) {
    ltn: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAADCAYAAABBCiV2AAAAGElEQVR42mN4nf3/PyHMQJSiyRmv/hPCACSbVe0aeuODAAAAAElFTkSuQmCC"
    eql: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAADCAYAAABBCiV2AAAAGElEQVR42mPo+/L/PyHMQJSiyRmv/hPCAAScWQUsjAs3AAAAAElFTkSuQmCC"
    gtn: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAADCAYAAABBCiV2AAAAGElEQVR42mPg5tH6TwgzEKXIzKXrPyEMAKotKJyhzZc5AAAAAElFTkSuQmCC"
  }

App.CardPlayer.card.attr_icons: Map<String>
  {
    "damage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAKCAYAAABi8KSDAAAATUlEQVR42mNgAIK+L///W+x48J8BCwCJg+QxBNA14BKHS8BMgbFx2ciArhDFelwaCCpEVoRuA0ETcdqA7DlsiuGexBk82IIPb/CgaQAAVVyucYmp1skAAAAASUVORK5CYII=" // offensive
    "resistance": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAALCAYAAACtWacbAAAAQ0lEQVR42mNgQAIWOx787/vy/z+IZkAHMEl0DFeMLoFVjChFMKsYsACcVmLjYzgcWRGGL7H5jmAwYA0rgoGJrhBdDABa1bsEjscb1AAAAABJRU5ErkJggg==" // defensive
    "mobility": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAKCAYAAABv7tTEAAAAQklEQVR42mOw2PHgf9+X/ygYmxgDOgApgmF0xTg1wTTisgWnJnTN6M7Fq4lkDVSxBT00sRqASxNBm/EFO9khCRIHABDzAc+vGvQQAAAAAElFTkSuQmCC" // mobility
    "range": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQElEQVR42mNggAKLHQ/+9335j4JBYgzIAKsgkmY4B6YI3UQUeZgAuqnIpoFpFA6Sqehi5CnEazXRniE6eIgNcADtwMQtWOgT0gAAAABJRU5ErkJggg==" // range
    "utility": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAMCAYAAACwXJejAAAAU0lEQVR42mNgQAIWOx787/vy/z+IZsAGQJLoGEMRzBSYBrymIdM4rYOZiKEQm/HI1qNysJgO1ozuI2QT4dZicwtGUCAHIDpGMRmXKRhhhc0kmBwAbSTOuAXc0NYAAAAASUVORK5CYII="// utility
  }
  

// Event handler
App.CardPlayer.when: App.When<App.CardPlayer.State>
  (event, state)
  App.pass!

// Global ticker: not used
App.CardPlayer.tick: App.Tick<App.CardPlayer.State>
  App.no_tick<App.CardPlayer.State>

// Global visitor: counts posts to room_zero
App.CardPlayer.post: App.Post<App.CardPlayer.State>
  (time, room, addr, data, global_state)
  global_state + 1

// A "CardPlayer, world!" + counter application
App.CardPlayer: App<App.CardPlayer.State>
  App.new<App.CardPlayer.State>(
    App.CardPlayer.init
    App.CardPlayer.draw
    App.CardPlayer.when
    App.CardPlayer.tick
    App.CardPlayer.post
  )
